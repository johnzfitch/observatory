<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Service Worker Fix</title>
  <style>
    body {
      font-family: monospace;
      background: #0a0a0f;
      color: #00ff88;
      padding: 20px;
    }
    h1 { color: #00ccff; }
    pre {
      background: #111;
      padding: 15px;
      border: 1px solid #333;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”§ Service Worker Fix</h1>
  <p>Clearing broken service worker and caches...</p>
  <pre id="log"></pre>
  <script>
    const log = document.getElementById('log');

    async function fix() {
      try {
        log.textContent += 'Starting cleanup...\n\n';

        // Unregister all service workers
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          log.textContent += `Found ${regs.length} service worker(s)\n`;

          for (const reg of regs) {
            await reg.unregister();
            log.textContent += `[OK] Unregistered: ${reg.scope}\n`;
          }
        }

        // Clear all caches
        if ('caches' in window) {
          const names = await caches.keys();
          log.textContent += `\nFound ${names.length} cache(s)\n`;

          for (const name of names) {
            await caches.delete(name);
            log.textContent += `[OK] Deleted cache: ${name}\n`;
          }
        }

        // Clear localStorage cache marker
        localStorage.removeItem('cache-nuclear-clear');
        localStorage.removeItem('deepfake-models-used');
        localStorage.removeItem('deepfake-detector-used');
        log.textContent += '\n[OK] Cleared localStorage markers\n';

        // Clear IndexedDB model cache
        if ('indexedDB' in window) {
          try {
            await new Promise((resolve, reject) => {
              const req = indexedDB.deleteDatabase('deepfake-detector-models');
              req.onsuccess = () => resolve();
              req.onerror = () => reject(req.error);
              req.onblocked = () => {
                log.textContent += '[WARN] IndexedDB blocked - close other tabs\n';
                resolve();
              };
            });
            log.textContent += '[OK] Deleted IndexedDB model cache\n';
          } catch (e) {
            log.textContent += `[WARN] IndexedDB delete failed: ${e.message}\n`;
          }
        }

        log.textContent += '\n[SUCCESS] Cleanup complete!\n';
        log.textContent += '\nReloading in 2 seconds...\n';

        setTimeout(() => {
          window.location.href = '/';
        }, 2000);

      } catch (e) {
        log.textContent += `\n[ERROR] Error: ${e.message}\n`;
        log.textContent += e.stack + '\n';
      }
    }

    fix();
  </script>
</body>
</html>
