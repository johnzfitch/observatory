# Phase 8: Mobile Fix (CRITICAL)

## Time: 2 hours

## Files: js/InferenceEngine.js, index.html

## The Bug

On mobile devices:
- umm_maybe and dima806_ai_real models cause blank page after completion
- Back button goes to previous SITE, not back in app
- Suggests page navigation or crash happening

## Likely Causes

1. **WebGPU memory exhaustion** - Mobile has limited GPU memory, large models crash the tab
2. **Unhandled exception** - Error in ONNX runtime kills the page
3. **window.location change** - Something redirecting
4. **Browser killing tab** - Resource pressure forces tab termination

## Investigation First

Add debug logging to understand what's happening:

```js
// Add at top of file
console.log('[Mobile Debug] Page loaded');

window.addEventListener('beforeunload', (e) => {
  console.log('[Mobile Debug] Page unloading!');
});

window.addEventListener('error', (e) => {
  console.error('[Mobile Debug] Global error:', e.error);
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('[Mobile Debug] Unhandled rejection:', e.reason);
});

// In model running code
async function runModel(model, image) {
  console.log(`[Mobile Debug] Starting ${model.id}`);
  try {
    const result = await model.run(image);
    console.log(`[Mobile Debug] Completed ${model.id}`);
    return result;
  } catch (error) {
    console.error(`[Mobile Debug] FAILED ${model.id}:`, error);
    throw error;
  }
}
```

Test on mobile with remote debugging (Chrome DevTools → Remote devices).

## Fix 1: Isolate Each Model in Try/Catch

Don't let one model crash everything:

```js
async function runModelSafe(model, image) {
  try {
    console.log(`[Model] Starting ${model.id}`);
    const result = await model.run(image);
    console.log(`[Model] Completed ${model.id}`);
    return { modelId: model.id, score: result.score, success: true };
  } catch (error) {
    console.error(`[Model] Failed ${model.id}:`, error);
    return { modelId: model.id, score: null, success: false, error: error.message };
  }
}

async function analyze(image) {
  const results = [];
  
  for (const model of this.models) {
    const result = await runModelSafe(model, image);
    results.push(result);
    
    // Small delay between models to let GPU breathe
    await new Promise(r => setTimeout(r, 100));
  }
  
  return results;
}
```

## Fix 2: Mobile Detection + Model Filtering

Skip problematic models on mobile:

```js
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ||
                 (navigator.maxTouchPoints > 0 && window.innerWidth < 768);

// Models known to work on mobile
const MOBILE_SAFE_MODELS = ['smogy', 'prithiv_v2'];
const ALL_MODELS = ['dima806_ai_real', 'smogy', 'umm_maybe', 'prithiv_v2'];

function getModelsForDevice() {
  if (isMobile) {
    console.log('[Device] Mobile detected - using reduced model set');
    return MOBILE_SAFE_MODELS;
  }
  return ALL_MODELS;
}

// In init or wherever models are configured
const modelsToLoad = getModelsForDevice();
```

## Fix 3: Show User Message

```js
if (isMobile && modelsToLoad.length < ALL_MODELS.length) {
  showToast(`Running ${modelsToLoad.length}/${ALL_MODELS.length} models (optimized for mobile)`, 5000);
}
```

## Fix 4: Memory Management

```js
// Check WebGPU limits before running large models
async function checkWebGPUCapacity() {
  if (!('gpu' in navigator)) {
    console.log('[WebGPU] Not available');
    return { available: false };
  }
  
  try {
    const adapter = await navigator.gpu.requestAdapter();
    if (!adapter) {
      return { available: false };
    }
    
    const device = await adapter.requestDevice();
    const limits = device.limits;
    
    console.log('[WebGPU] Limits:', {
      maxBufferSize: limits.maxBufferSize,
      maxStorageBufferBindingSize: limits.maxStorageBufferBindingSize
    });
    
    return {
      available: true,
      limits,
      // Rough heuristic: if max buffer < 256MB, consider it constrained
      constrained: limits.maxBufferSize < 256 * 1024 * 1024
    };
  } catch (error) {
    console.error('[WebGPU] Check failed:', error);
    return { available: false, error };
  }
}

// Use in init
const gpuCapacity = await checkWebGPUCapacity();
if (gpuCapacity.constrained) {
  console.log('[Device] Constrained GPU - using reduced models');
  // Use mobile-safe models even on desktop with weak GPU
}
```

## Fix 5: Sequential Processing on Mobile

```js
async function analyze(image) {
  if (isMobile) {
    // Sequential with cleanup between models
    return await this.analyzeSequential(image);
  } else {
    // Parallel (existing behavior)
    return await this.analyzeParallel(image);
  }
}

async function analyzeSequential(image) {
  const results = [];
  
  for (const model of this.models) {
    // Run single model
    const result = await runModelSafe(model, image);
    results.push(result);
    
    // Force garbage collection opportunity
    await new Promise(r => setTimeout(r, 200));
    
    // Optional: Explicitly release tensors if ONNX supports it
    // model.releaseMemory?.();
  }
  
  return results;
}
```

## Fix 6: Prevent Blank Page

Add a safety wrapper around the entire analysis:

```js
async function safeAnalyze() {
  try {
    AppState.current = 'ANALYZING';
    const results = await inferenceEngine.analyze(currentImage);
    displayResults(results);
    AppState.current = 'RESULTS';
  } catch (error) {
    console.error('[Analysis] Fatal error:', error);
    
    // DON'T let this crash the page
    AppState.current = 'READY';
    showError('Analysis failed. Please try again or use a different image.');
    
    // Reset UI to usable state
    endButtonProgress();
    showUploadArea();
  }
}
```

## Testing Checklist

Test on REAL mobile device (not just browser dev tools responsive mode):

- [ ] Page loads without crash
- [ ] Models load (check which ones)
- [ ] Upload image works
- [ ] Analysis starts
- [ ] NO blank page
- [ ] Back button stays in app
- [ ] Results display (even if partial)
- [ ] Can upload and analyze second image

## Remote Debugging Setup

1. Connect Android phone via USB
2. Enable USB debugging on phone
3. Open chrome://inspect on desktop Chrome
4. Find your page in "Remote Target"
5. Click "inspect" to open DevTools for mobile

For iOS:
1. Enable Web Inspector in Safari settings
2. Connect via USB
3. Open Safari on Mac → Develop menu → [Device name]

## Done when

- Mobile doesn't crash to blank page
- Analysis completes (with available models)
- User informed if running reduced models
- Back button works correctly
- Can analyze multiple images in sequence
